# =============================================================================
# docker-compose.yml â€” Week 12: Email Protocols and RPC
# NETWORKING class - ASE, Informatics | by Revolvix
# =============================================================================
#
# This configuration provides an isolated laboratory environment for exploring
# SMTP and RPC protocols. All services are containerised for reproducibility.
#
# Usage:
#   docker compose up -d
#   docker compose logs -f
#   docker compose down
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Main laboratory container
  # Contains Python environment and all protocol implementations
  # ---------------------------------------------------------------------------
  lab:
    container_name: week12_lab
    build:
      context: ..
      dockerfile: docker/Dockerfile
    working_dir: /app
    environment:
      - PYTHONUNBUFFERED=1
      - SMTP_HOST=0.0.0.0
      - SMTP_PORT=1025
      - JSONRPC_HOST=0.0.0.0
      - JSONRPC_PORT=6200
      - XMLRPC_HOST=0.0.0.0
      - XMLRPC_PORT=6201
      - GRPC_HOST=0.0.0.0
      - GRPC_PORT=6251
    volumes:
      - ..:/app:rw
      - spool_data:/app/spool
      - ./volumes/spool:/app/docker/volumes/spool:rw
    ports:
      - "${SMTP_PORT:-1025}:1025"
      - "${JSONRPC_PORT:-6200}:6200"
      - "${XMLRPC_PORT:-6201}:6201"
      - "${GRPC_PORT:-6251}:6251"
    networks:
      - week12_net
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.socket(); s.settimeout(1); s.connect(('127.0.0.1', 1025)); s.close()"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    command: >
      bash -c "
        echo 'Starting Week 12 Laboratory Services...' &&
        python /app/src/apps/email/smtp_server.py --host 0.0.0.0 --port 1025 --spool /app/docker/volumes/spool &
        python /app/src/apps/rpc/jsonrpc/jsonrpc_server.py --host 0.0.0.0 --port 6200 &
        python /app/src/apps/rpc/xmlrpc/xmlrpc_server.py --host 0.0.0.0 --port 6201 &
        python /app/src/apps/rpc/grpc/grpc_server.py --host 0.0.0.0 --port 6251 &
        echo 'All services started. Keeping container alive...' &&
        tail -f /dev/null
      "

  # ---------------------------------------------------------------------------
  # Portainer CE - Docker Management UI
  # Access at https://localhost:9443
  # ---------------------------------------------------------------------------
  portainer:
    container_name: week12_portainer
    image: portainer/portainer-ce:latest
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    ports:
      - "${PORTAINER_PORT:-9443}:9443"
    networks:
      - week12_net

# =============================================================================
# Networks
# =============================================================================
networks:
  week12_net:
    name: week12_net
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.12.0/24

# =============================================================================
# Volumes
# =============================================================================
volumes:
  spool_data:
    name: week12_spool
  portainer_data:
    name: week12_portainer_data
