# =============================================================================
# docker-compose.yml — Week 11 WSL Kit
# =============================================================================
# NETWORKING class - ASE, Informatics | by ing. dr. Antonio Clim
#
# Adapted for WSL2 + Ubuntu 22.04 + Docker + Portainer Environment
#
# IMPORTANT: Portainer runs as a GLOBAL service on port 9000.
# It is NOT included in this compose file and should NEVER be
# started or stopped by weekly laboratory scripts.
#
# To access Portainer: http://localhost:9000
# Credentials: Set at first login (see setup/.env.example for guidance)
#
# Stack: 1 Nginx Load Balancer + 3 Backend Servers
#
# SECURITY: This configuration includes container hardening options.
# =============================================================================

services:
  # ─────────────────────────────────────────────────────────────────────────
  # Nginx Reverse Proxy / Load Balancer
  # ─────────────────────────────────────────────────────────────────────────
  nginx:
    image: nginx:alpine
    container_name: s11_nginx_lb
    ports:
      - "8080:80"
    volumes:
      - ./configs/nginx.conf:/etc/nginx/nginx.conf:ro
    environment:
      - LAB_WEEK=11
    depends_on:
      - web1
      - web2
      - web3
    networks:
      - s11_net
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /var/cache/nginx
      - /var/run
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETGID
      - SETUID
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────
  # Backend Servers (3 identical instances with different content)
  # ─────────────────────────────────────────────────────────────────────────
  web1:
    image: nginx:alpine
    container_name: s11_backend_1
    volumes:
      - ./web1:/usr/share/nginx/html:ro
    environment:
      - LAB_WEEK=11
      - BACKEND_ID=1
    networks:
      - s11_net
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /var/cache/nginx
      - /var/run
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETGID
      - SETUID
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 10s
      timeout: 5s
      retries: 3

  web2:
    image: nginx:alpine
    container_name: s11_backend_2
    volumes:
      - ./web2:/usr/share/nginx/html:ro
    environment:
      - LAB_WEEK=11
      - BACKEND_ID=2
    networks:
      - s11_net
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /var/cache/nginx
      - /var/run
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETGID
      - SETUID
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 10s
      timeout: 5s
      retries: 3

  web3:
    image: nginx:alpine
    container_name: s11_backend_3
    volumes:
      - ./web3:/usr/share/nginx/html:ro
    environment:
      - LAB_WEEK=11
      - BACKEND_ID=3
    networks:
      - s11_net
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /var/cache/nginx
      - /var/run
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETGID
      - SETUID
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 10s
      timeout: 5s
      retries: 3

# ─────────────────────────────────────────────────────────────────────────
# Network Configuration
# ─────────────────────────────────────────────────────────────────────────
networks:
  s11_net:
    name: s11_network
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# =============================================================================
# SECURITY NOTES:
# - All containers run with no-new-privileges
# - Root filesystem is read-only where possible
# - Capabilities are dropped to minimum required
# - Credentials are NOT stored in this file (see setup/.env.example)
# =============================================================================
