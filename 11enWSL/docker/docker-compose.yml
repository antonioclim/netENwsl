# =============================================================================
# docker-compose.yml – Week 11 WSL Kit
# =============================================================================
# NETWORKING class - ASE, Informatics | by Revolvix
#
# Adapted for WSL2 + Ubuntu 22.04 + Docker + Portainer Environment
#
# IMPORTANT: Portainer runs as a GLOBAL service on port 9000.
# It is NOT included in this compose file and should NEVER be
# started or stopped by weekly laboratory scripts.
#
# To access Portainer: http://localhost:9000
# Credentials: stud / studstudstud
#
# Port 9000 is RESERVED for Portainer - do not use for any service!
#
# Stack: 1 Nginx Load Balancer + 3 Backend Servers
#
# Usage:
#   docker compose up -d           # Start all services
#   docker compose down            # Stop all services
#   docker compose down -v         # Stop and remove volumes
#   docker compose logs -f nginx   # View Nginx logs
# =============================================================================

services:
  # ─────────────────────────────────────────────────────────────────────────
  # Nginx Reverse Proxy / Load Balancer
  # NOTE: Port 9000 is RESERVED for Portainer - NEVER use it here!
  # ─────────────────────────────────────────────────────────────────────────
  nginx:
    image: nginx:alpine
    container_name: s11_nginx_lb
    ports:
      - "8080:80"
    volumes:
      - ./configs/nginx.conf:/etc/nginx/nginx.conf:ro
    environment:
      - LAB_WEEK=11
    depends_on:
      - web1
      - web2
      - web3
    networks:
      - s11_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────
  # Backend Servers (3 identical instances with different content)
  # ─────────────────────────────────────────────────────────────────────────
  web1:
    image: nginx:alpine
    container_name: s11_backend_1
    volumes:
      - ./web1:/usr/share/nginx/html:ro
    environment:
      - LAB_WEEK=11
      - BACKEND_ID=1
    networks:
      - s11_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 10s
      timeout: 5s
      retries: 3

  web2:
    image: nginx:alpine
    container_name: s11_backend_2
    volumes:
      - ./web2:/usr/share/nginx/html:ro
    environment:
      - LAB_WEEK=11
      - BACKEND_ID=2
    networks:
      - s11_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 10s
      timeout: 5s
      retries: 3

  web3:
    image: nginx:alpine
    container_name: s11_backend_3
    volumes:
      - ./web3:/usr/share/nginx/html:ro
    environment:
      - LAB_WEEK=11
      - BACKEND_ID=3
    networks:
      - s11_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 10s
      timeout: 5s
      retries: 3

# ─────────────────────────────────────────────────────────────────────────
# Network Configuration
# NOTE: Portainer uses its own network, managed globally
# ─────────────────────────────────────────────────────────────────────────
networks:
  s11_net:
    name: s11_network
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# =============================================================================
# NOTE: Portainer runs globally and is NOT defined here
# Access Portainer at: http://localhost:9000
#
# EXERCISES:
# 1. Modify nginx.conf to use different load balancing algorithms
# 2. Add weights to backends (e.g., web1 weight=3, web2 weight=2, web3 weight=1)
# 3. Test failover by stopping a backend: docker stop s11_backend_2
# 4. View Nginx access logs: docker compose logs -f nginx
# =============================================================================

# Revolvix&Hypotheticalandrei
