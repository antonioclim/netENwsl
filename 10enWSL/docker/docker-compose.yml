# Docker Compose - Week 10: Network Services
# HTTP, DNS, SSH and FTP in orchestrated containers for the Application Layer laboratory.
# NETWORKING class - ASE, Informatics | by Revolvix

networks:
  labnet:
    driver: bridge
    name: week10_labnet
    ipam:
      config:
        - subnet: 172.20.0.0/24

volumes:
  ssh_data:
    name: week10_ssh_data
  ftp_data:
    name: week10_ftp_data

services:
  # ============================================================================
  # WEB - Minimal HTTP service for demonstrating Docker networking
  # ============================================================================
  web:
    image: python:3.12-alpine
    container_name: week10_web
    command: ["python3", "-m", "http.server", "8000", "--bind", "0.0.0.0", "--directory", "/www"]
    volumes:
      - ./www:/www:ro
    networks:
      labnet:
        ipv4_address: 172.20.0.10
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8000/"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============================================================================
  # DNS-SERVER - Custom DNS server (dnslib) on UDP 5353
  # Responds for:
  #   myservice.lab.local -> 10.10.10.10
  #   api.lab.local       -> 10.10.10.20
  #   web.lab.local       -> 172.20.0.10
  #   ssh.lab.local       -> 172.20.0.22
  #   ftp.lab.local       -> 172.20.0.21
  # ============================================================================
  dns-server:
    build:
      context: ./dns-server
      dockerfile: Dockerfile
    container_name: week10_dns
    networks:
      labnet:
        ipv4_address: 172.20.0.53
    ports:
      - "5353:5353/udp"
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(socket.AF_INET, socket.SOCK_DGRAM); s.settimeout(1); s.close()"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============================================================================
  # SSH-SERVER - OpenSSH server with a predefined user
  # User: labuser / Password: labpass
  # ============================================================================
  ssh-server:
    build:
      context: ./ssh-server
      dockerfile: Dockerfile
    container_name: week10_ssh
    networks:
      labnet:
        ipv4_address: 172.20.0.22
    ports:
      - "2222:22"
    volumes:
      - ssh_data:/home/labuser/storage
    healthcheck:
      test: ["CMD", "pgrep", "sshd"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============================================================================
  # SSH-CLIENT - Container with Paramiko for SSH automation
  # ============================================================================
  ssh-client:
    build:
      context: ./ssh-client
      dockerfile: Dockerfile
    container_name: week10_ssh_client
    networks:
      labnet:
        ipv4_address: 172.20.0.100
    depends_on:
      ssh-server:
        condition: service_healthy
    stdin_open: true
    tty: true
    volumes:
      - ./ssh-client:/app:ro

  # ============================================================================
  # FTP-SERVER - pyftpdlib on port 2121
  # User: labftp / Password: labftp
  # ============================================================================
  ftp-server:
    build:
      context: ./ftp-server
      dockerfile: Dockerfile
    container_name: week10_ftp
    networks:
      labnet:
        ipv4_address: 172.20.0.21
    ports:
      - "2121:2121"
      - "30000-30009:30000-30009"
    volumes:
      - ftp_data:/home/ftp
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.settimeout(2); s.connect(('localhost',2121)); s.close()"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============================================================================
  # DEBUG - Toolbox container with dig, curl, ssh, lftp, tcpdump and nmap
  # ============================================================================
  debug:
    build:
      context: ./debug
      dockerfile: Dockerfile
    container_name: week10_debug
    networks:
      labnet:
        ipv4_address: 172.20.0.200
    depends_on:
      - web
      - dns-server
      - ssh-server
      - ftp-server
    stdin_open: true
    tty: true
    cap_add:
      - NET_ADMIN
      - NET_RAW

  # ============================================================================
  # PORTAINER - Web-based Docker management (optional but recommended)
  # ============================================================================
  portainer:
    image: portainer/portainer-ce:latest
    container_name: week10_portainer
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    ports:
      - "9443:9443"
    restart: unless-stopped

volumes:
  portainer_data:
    name: week10_portainer_data
