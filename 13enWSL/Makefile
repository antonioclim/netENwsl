# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Week 13: IoT and Security โ Laboratory Makefile
# Computer Networks โ ASE, CSIE | by ing. dr. Antonio Clim
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
#
# Usage:
#   make help     - Show all available targets
#   make start    - Start laboratory environment
#   make quiz     - Run formative assessment quiz
#   make test     - Run all tests
#
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

.PHONY: help start stop restart quiz quiz-random test smoke lint verify clean all

# Configuration
PYTHON := python3
COMPOSE := docker compose -f docker/docker-compose.yml
QUIZ_FILE := formative/quiz.yaml

# Colors for output
GREEN := \033[0;32m
YELLOW := \033[0;33m
CYAN := \033[0;36m
RESET := \033[0m

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# DEFAULT TARGET
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

help:
	@echo ""
	@echo "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(RESET)"
	@echo "$(CYAN)โ         Week 13: IoT and Security Laboratory                     โ$(RESET)"
	@echo "$(CYAN)โ         Computer Networks โ ASE, CSIE                            โ$(RESET)"
	@echo "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ$(RESET)"
	@echo "$(CYAN)โ  ENVIRONMENT                                                     โ$(RESET)"
	@echo "$(CYAN)โ    make start      - Start laboratory containers                 โ$(RESET)"
	@echo "$(CYAN)โ    make stop       - Stop laboratory containers                  โ$(RESET)"
	@echo "$(CYAN)โ    make restart    - Restart laboratory environment              โ$(RESET)"
	@echo "$(CYAN)โ    make status     - Show container status                       โ$(RESET)"
	@echo "$(CYAN)โ                                                                  โ$(RESET)"
	@echo "$(CYAN)โ  ASSESSMENT                                                      โ$(RESET)"
	@echo "$(CYAN)โ    make quiz       - Run full formative quiz (10 questions)      โ$(RESET)"
	@echo "$(CYAN)โ    make quiz-random- Run random 5 questions                      โ$(RESET)"
	@echo "$(CYAN)โ    make quiz-bloom - Run quiz filtered by Bloom level            โ$(RESET)"
	@echo "$(CYAN)โ                                                                  โ$(RESET)"
	@echo "$(CYAN)โ  TESTING                                                         โ$(RESET)"
	@echo "$(CYAN)โ    make test       - Run all tests                               โ$(RESET)"
	@echo "$(CYAN)โ    make smoke      - Run smoke tests only                        โ$(RESET)"
	@echo "$(CYAN)โ    make lint       - Check code syntax                           โ$(RESET)"
	@echo "$(CYAN)โ    make verify     - Verify environment setup                    โ$(RESET)"
	@echo "$(CYAN)โ                                                                  โ$(RESET)"
	@echo "$(CYAN)โ  MAINTENANCE                                                     โ$(RESET)"
	@echo "$(CYAN)โ    make clean      - Clean artifacts and caches                  โ$(RESET)"
	@echo "$(CYAN)โ    make clean-full - Full cleanup including Docker               โ$(RESET)"
	@echo "$(CYAN)โ    make all        - Full cycle: lint โ test โ quiz              โ$(RESET)"
	@echo "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(RESET)"
	@echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ENVIRONMENT MANAGEMENT
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

start:
	@echo "$(GREEN)๐ Starting Week 13 laboratory environment...$(RESET)"
	@$(PYTHON) scripts/start_lab.py
	@echo "$(GREEN)โ Laboratory started. Access:$(RESET)"
	@echo "   - Portainer: http://localhost:9000"
	@echo "   - DVWA:      http://localhost:8080"
	@echo "   - MQTT:      localhost:1883 (plain) / 8883 (TLS)"

stop:
	@echo "$(YELLOW)๐ Stopping Week 13 laboratory...$(RESET)"
	@$(PYTHON) scripts/stop_lab.py
	@echo "$(GREEN)โ Laboratory stopped.$(RESET)"

restart: stop start
	@echo "$(GREEN)โ Laboratory restarted.$(RESET)"

status:
	@echo "$(CYAN)๐ Container Status:$(RESET)"
	@docker ps --filter "name=week13" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

logs:
	@echo "$(CYAN)๐ Recent logs (all containers):$(RESET)"
	@docker logs week13_mosquitto --tail 10 2>/dev/null || echo "  mosquitto: not running"
	@docker logs week13_dvwa --tail 10 2>/dev/null || echo "  dvwa: not running"
	@docker logs week13_vsftpd --tail 10 2>/dev/null || echo "  vsftpd: not running"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# FORMATIVE ASSESSMENT
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

quiz:
	@echo "$(GREEN)๐ Starting formative quiz...$(RESET)"
	@$(PYTHON) formative/run_quiz.py

quiz-random:
	@echo "$(GREEN)๐ Starting random quiz (5 questions)...$(RESET)"
	@$(PYTHON) formative/run_quiz.py --random --limit 5

quiz-bloom:
	@echo "$(CYAN)Available Bloom levels: remember, understand, apply, analyze, evaluate, create$(RESET)"
	@read -p "Enter Bloom level: " level; \
	$(PYTHON) formative/run_quiz.py --bloom $$level

quiz-export:
	@echo "$(GREEN)๐ Running quiz with export...$(RESET)"
	@$(PYTHON) formative/run_quiz.py --export artifacts/quiz_results.json
	@echo "$(GREEN)โ Results exported to artifacts/quiz_results.json$(RESET)"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# TESTING
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

test: lint smoke
	@echo "$(GREEN)๐งช Running exercise tests...$(RESET)"
	@$(PYTHON) tests/test_exercises.py --all || true
	@echo "$(GREEN)โ Tests completed.$(RESET)"

smoke:
	@echo "$(CYAN)๐จ Running smoke tests...$(RESET)"
	@$(PYTHON) tests/smoke_test.py

lint:
	@echo "$(CYAN)๐ Checking Python syntax...$(RESET)"
	@$(PYTHON) -m py_compile src/exercises/*.py && echo "  โ src/exercises/ OK"
	@$(PYTHON) -m py_compile scripts/*.py && echo "  โ scripts/ OK"
	@$(PYTHON) -m py_compile tests/*.py && echo "  โ tests/ OK"
	@$(PYTHON) -m py_compile formative/*.py 2>/dev/null && echo "  โ formative/ OK" || true
	@echo "$(GREEN)โ Syntax check passed.$(RESET)"

verify:
	@echo "$(CYAN)๐ง Verifying environment...$(RESET)"
	@$(PYTHON) setup/verify_environment.py

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# EXERCISES (shortcuts)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ex1:
	@echo "$(CYAN)Running Exercise 1: Port Scanner$(RESET)"
	@$(PYTHON) src/exercises/ex_13_01_port_scanner.py --help

ex2:
	@echo "$(CYAN)Running Exercise 2: MQTT Client$(RESET)"
	@$(PYTHON) src/exercises/ex_13_02_mqtt_client.py --help

ex3:
	@echo "$(CYAN)Running Exercise 3: Packet Sniffer$(RESET)"
	@$(PYTHON) src/exercises/ex_13_03_packet_sniffer.py --help

ex4:
	@echo "$(CYAN)Running Exercise 4: Vulnerability Checker$(RESET)"
	@$(PYTHON) src/exercises/ex_13_04_vuln_checker.py --help

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# MAINTENANCE
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

clean:
	@echo "$(YELLOW)๐งน Cleaning artifacts and caches...$(RESET)"
	@rm -rf artifacts/*.pcap artifacts/*.log artifacts/*.json 2>/dev/null || true
	@rm -rf __pycache__ */__pycache__ */*/__pycache__ 2>/dev/null || true
	@find . -name "*.pyc" -delete 2>/dev/null || true
	@find . -name ".pytest_cache" -type d -exec rm -rf {} + 2>/dev/null || true
	@echo "$(GREEN)โ Cleanup complete.$(RESET)"

clean-full: clean
	@echo "$(YELLOW)๐งน Full cleanup including Docker resources...$(RESET)"
	@$(PYTHON) scripts/cleanup.py --full 2>/dev/null || true
	@echo "$(GREEN)โ Full cleanup complete.$(RESET)"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# COMBINED WORKFLOWS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

all: lint smoke test quiz
	@echo ""
	@echo "$(GREEN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(RESET)"
	@echo "$(GREEN)  โ All checks completed successfully!$(RESET)"
	@echo "$(GREEN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(RESET)"

# Pre-lab check (run before starting a lab session)
prelab: verify lint
	@echo "$(GREEN)โ Pre-lab checks passed. Ready to start!$(RESET)"
	@echo "$(CYAN)Run 'make start' to begin the laboratory.$(RESET)"

# Post-lab cleanup
postlab: stop clean
	@echo "$(GREEN)โ Post-lab cleanup complete.$(RESET)"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# DOCUMENTATION
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

docs:
	@echo "$(CYAN)๐ Available documentation:$(RESET)"
	@echo "   README.md              - Main laboratory guide"
	@echo "   SECURITY.md            - Security notice and guidelines"
	@echo "   docs/theory_summary.md - Theoretical background"
	@echo "   docs/troubleshooting.md- Problem solving guide"
	@echo "   docs/misconceptions.md - Common errors"
	@echo "   docs/peer_instruction.md - Discussion questions"

# Show security notice
security:
	@cat SECURITY.md | head -50
	@echo ""
	@echo "$(YELLOW)... (see SECURITY.md for full document)$(RESET)"
