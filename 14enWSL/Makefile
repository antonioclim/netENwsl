# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Makefile โ Week 14 Lab Kit Orchestrator
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# NETWORKING class โ ASE, CSIE | Computer Networks Laboratory
# by ing. dr. Antonio Clim
#
# Usage: make <target>
# Run `make help` to see all available targets
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

.PHONY: help install lint test quiz docker-up docker-down docker-logs \
        validate clean smoke capture verify-env all ci

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CONFIGURATION
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

PYTHON := python3
PIP := pip3
DOCKER_COMPOSE := docker compose -f docker/docker-compose.yml
PYTEST := $(PYTHON) -m pytest
RUFF := $(PYTHON) -m ruff

# Colours for output
GREEN := \033[0;32m
YELLOW := \033[0;33m
RED := \033[0;31m
CYAN := \033[0;36m
NC := \033[0m # No Colour

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# HELP
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

help:
	@echo ""
	@echo "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)"
	@echo "$(CYAN)โ$(NC)  $(GREEN)Week 14 Lab Kit โ Available Commands$(NC)                        $(CYAN)โ$(NC)"
	@echo "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ$(NC)"
	@echo "$(CYAN)โ$(NC)                                                               $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)  $(YELLOW)Setup & Installation:$(NC)                                       $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)    make install      - Install Python dependencies            $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)    make verify-env   - Verify environment setup               $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)                                                               $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)  $(YELLOW)Development:$(NC)                                                $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)    make lint         - Run code linter (ruff)                 $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)    make test         - Run all unit tests                     $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)    make smoke        - Run smoke tests only                   $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)    make validate     - Validate entire kit integrity          $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)                                                               $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)  $(YELLOW)Docker Environment:$(NC)                                         $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)    make docker-up    - Start lab containers                   $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)    make docker-down  - Stop lab containers                    $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)    make docker-logs  - View container logs                    $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)    make docker-ps    - Show container status                  $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)                                                               $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)  $(YELLOW)Learning & Assessment:$(NC)                                      $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)    make quiz         - Run formative assessment quiz          $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)    make quiz-random  - Run quiz with randomized questions     $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)    make capture      - Capture network traffic                $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)                                                               $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)  $(YELLOW)Maintenance:$(NC)                                                $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)    make clean        - Clean generated artifacts              $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)    make ci           - Run full CI pipeline locally           $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)    make all          - Setup and start everything             $(CYAN)โ$(NC)"
	@echo "$(CYAN)โ$(NC)                                                               $(CYAN)โ$(NC)"
	@echo "$(CYAN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)"
	@echo ""
	@echo "$(GREEN)NETWORKING class โ ASE, CSIE | by ing. dr. Antonio Clim$(NC)"
	@echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# SETUP & INSTALLATION
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

install:
	@echo "$(CYAN)๐ฆ Installing dependencies...$(NC)"
	$(PIP) install --upgrade pip
	$(PIP) install -r setup/requirements.txt
	$(PIP) install ruff pytest pytest-timeout
	@echo "$(GREEN)โ Dependencies installed$(NC)"

verify-env:
	@echo "$(CYAN)๐ Verifying environment...$(NC)"
	$(PYTHON) setup/verify_environment.py

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# DEVELOPMENT
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

lint:
	@echo "$(CYAN)๐ Running linter...$(NC)"
	$(RUFF) check src/ scripts/ tests/ formative/ || true
	@echo "$(GREEN)โ Linting complete$(NC)"

lint-fix:
	@echo "$(CYAN)๐ง Auto-fixing lint issues...$(NC)"
	$(RUFF) check --fix src/ scripts/ tests/ formative/
	$(RUFF) format src/ scripts/ tests/ formative/
	@echo "$(GREEN)โ Lint fixes applied$(NC)"

test:
	@echo "$(CYAN)๐งช Running all tests...$(NC)"
	$(PYTEST) tests/ -v --tb=short --timeout=60
	@echo "$(GREEN)โ Tests complete$(NC)"

smoke:
	@echo "$(CYAN)๐ฌ Running smoke tests...$(NC)"
	$(PYTHON) tests/smoke_test.py
	@echo "$(GREEN)โ Smoke tests complete$(NC)"

validate:
	@echo "$(CYAN)โ Validating kit integrity...$(NC)"
	@# Validate YAML quiz
	$(PYTHON) -c "import yaml; yaml.safe_load(open('formative/quiz_week14.yaml'))" && \
		echo "  $(GREEN)โ YAML quiz valid$(NC)"
	@# Validate JSON quiz
	$(PYTHON) -c "import json; json.load(open('formative/quiz_week14.json'))" && \
		echo "  $(GREEN)โ JSON quiz valid$(NC)"
	@# Validate Python syntax
	$(PYTHON) -m py_compile formative/run_quiz.py && \
		echo "  $(GREEN)โ Quiz runner valid$(NC)"
	@# Check required files
	@test -f README.md && echo "  $(GREEN)โ README.md exists$(NC)"
	@test -f CHANGELOG.md && echo "  $(GREEN)โ CHANGELOG.md exists$(NC)"
	@test -f SECURITY.md && echo "  $(GREEN)โ SECURITY.md exists$(NC)"
	@test -f docs/learning_objectives.md && echo "  $(GREEN)โ LO matrix exists$(NC)"
	@echo "$(GREEN)โ Kit validation complete$(NC)"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# DOCKER ENVIRONMENT
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

docker-up:
	@echo "$(CYAN)๐ Starting lab environment...$(NC)"
	$(DOCKER_COMPOSE) up -d
	@echo "$(YELLOW)โณ Waiting for services to initialize...$(NC)"
	@sleep 10
	$(DOCKER_COMPOSE) ps
	@echo ""
	@echo "$(GREEN)โ Lab environment ready$(NC)"
	@echo ""
	@echo "$(CYAN)Access points:$(NC)"
	@echo "  Load Balancer: http://localhost:8080"
	@echo "  Backend 1:     http://localhost:8001"
	@echo "  Backend 2:     http://localhost:8002"
	@echo "  TCP Echo:      localhost:9090"
	@echo "  Portainer:     http://localhost:9000"
	@echo ""

docker-down:
	@echo "$(CYAN)๐ Stopping lab environment...$(NC)"
	$(DOCKER_COMPOSE) down
	@echo "$(GREEN)โ Lab environment stopped$(NC)"

docker-logs:
	@echo "$(CYAN)๐ Container logs (Ctrl+C to exit)...$(NC)"
	$(DOCKER_COMPOSE) logs -f

docker-ps:
	@echo "$(CYAN)๐ Container status:$(NC)"
	$(DOCKER_COMPOSE) ps

docker-restart:
	@echo "$(CYAN)๐ Restarting lab environment...$(NC)"
	$(DOCKER_COMPOSE) restart
	@echo "$(GREEN)โ Containers restarted$(NC)"

docker-rebuild:
	@echo "$(CYAN)๐จ Rebuilding Docker images...$(NC)"
	$(DOCKER_COMPOSE) build --no-cache
	@echo "$(GREEN)โ Images rebuilt$(NC)"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# LEARNING & ASSESSMENT
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

quiz:
	@echo "$(CYAN)๐ Starting formative assessment quiz...$(NC)"
	@echo ""
	$(PYTHON) formative/run_quiz.py

quiz-random:
	@echo "$(CYAN)๐ Starting quiz (randomized)...$(NC)"
	@echo ""
	$(PYTHON) formative/run_quiz.py --random

quiz-quick:
	@echo "$(CYAN)๐ Starting quick quiz (5 questions)...$(NC)"
	@echo ""
	$(PYTHON) formative/run_quiz.py --random --limit 5 --no-prediction

quiz-export:
	@echo "$(CYAN)๐ค Exporting quiz to JSON...$(NC)"
	$(PYTHON) formative/run_quiz.py --export json --output quiz_export.json
	@echo "$(GREEN)โ Quiz exported to quiz_export.json$(NC)"

capture:
	@echo "$(CYAN)๐ก Starting traffic capture...$(NC)"
	$(PYTHON) scripts/capture_traffic.py

demo:
	@echo "$(CYAN)๐ฌ Running demonstration...$(NC)"
	$(PYTHON) scripts/run_demo.py

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# MAINTENANCE
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

clean:
	@echo "$(CYAN)๐งน Cleaning artifacts...$(NC)"
	rm -rf artifacts/*.pcap artifacts/*.log 2>/dev/null || true
	rm -rf __pycache__ */__pycache__ */*/__pycache__ 2>/dev/null || true
	rm -rf .pytest_cache .ruff_cache 2>/dev/null || true
	rm -rf *.pyc */*.pyc */*/*.pyc 2>/dev/null || true
	rm -rf .coverage coverage.xml htmlcov/ 2>/dev/null || true
	@echo "$(GREEN)โ Artifacts cleaned$(NC)"

clean-docker:
	@echo "$(CYAN)๐งน Cleaning Docker resources...$(NC)"
	$(DOCKER_COMPOSE) down --volumes --remove-orphans
	docker image prune -f
	@echo "$(GREEN)โ Docker resources cleaned$(NC)"

clean-all: clean clean-docker
	@echo "$(GREEN)โ Full cleanup complete$(NC)"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CI PIPELINE (LOCAL)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ci: lint test validate
	@echo ""
	@echo "$(GREEN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)"
	@echo "$(GREEN)โ Local CI pipeline complete$(NC)"
	@echo "$(GREEN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# FULL SETUP
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

all: install verify-env docker-up smoke
	@echo ""
	@echo "$(GREEN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)"
	@echo "$(GREEN)โ Lab environment ready!$(NC)"
	@echo "$(GREEN)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(NC)"
	@echo ""
	@echo "$(CYAN)Next steps:$(NC)"
	@echo "  1. Run 'make quiz' to test your knowledge"
	@echo "  2. Open http://localhost:8080 in your browser"
	@echo "  3. Start Wireshark and capture traffic"
	@echo ""
